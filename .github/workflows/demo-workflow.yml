name: Demo GitHub Actions Workflow

on: [workflow-dispatch]

jobs:
  build:
    runs-on: ubuntu-latest # The type of runner that the job will run on
    defaults:
      runs:
        working-directory: ./HelloWorld
      steps:
        - name: Checkout repository code
          uses: actions/checkout@v4 # Action to check out the repository's code
        - run: javac *.java

        - name: Create JAR
          run: |
            jar cf HelloWorld.jar -C out/production/HelloWorld . 
            mv *.jar out/artifacts/HelloWorld_jar/

        - name: Upload JAR 
          uses: actions/upload-artifact@v4
          with:
            name: HelloWorld.jar
            path: ${{github.workspace}}/HelloWorld/out/artifacts/HelloWorld_jar/HelloWorld.jar
            retention-days: 1

sign:
  runs-on: ubuntu-latest # The type of runner that the job will run on
  needs: build 
  steps:

  - name: Download artifact from Build-Java
    uses: actions/download-artifact@v4
    with:
      name: HelloWorld.jar

  - name: SignServer Signing
    uses: Keyfactor/signserver-signing-action@v1.0.0
    with:
      endpoint: ${{secrets.SIGNSERVER_URL}} 
      file-path: ${{github.workspace}}/HelloWorld.jar 
      worker-name: JArchiveSigner
      worker-type: JArchiveSigner

verify:
  runs-on: ubuntu-latest # The type of runner that the job will run on
  needs: sign 
  steps:

  - name: Download Signed JAR
    uses: action/download-artifact@v4 
    with:
      name: signed-input.jar

  - name: Verify JAR
    run: |
      jarsigner -verify -verbose ${{github.workspace}}/signed-input.jar
